{% extends "base.html" %}

{% block content %}

<div class="container text-center">

    {% if message %}

    <h4>{{ message }}</h4>

    {% else %}

    <h3>{{ session.year }}-{{ session.month }} {{ session.group }}å¿—åŒé“åˆåœ˜åŒ¯æ¬¾å…¬å‘Š</h3>
    <h5 id="userName" fbuid="{{ member.fbid }}">è¨‚è³¼äººï¼š{{ member.name }}</h5>
    
    {% if checkout %}
    <h3>è¨‚å–®ç·¨è™Ÿï¼š{{ checkout.checkout_id }}</h3>
    {% endif %}
    
    <br>
    <table id="table-items">
        <tr>
            <th>åœ˜è³¼æ‰¹è™Ÿ</th>
            <th>å•†å“ç·¨è™Ÿ</th>
            <th>å•†å“åç¨±</th>
            <th>æ•¸é‡</th>
            <th>å•†å“å–®åƒ¹</th>
            <th>å•†å“ç¸½åƒ¹</th>
            <th>å‚™è¨»</th>
        </tr>

        {% for order in orders %}
        <tr>
            <td>{{ session.session_id }}</td>
            <td>{{ order.product.wine_id }}</td>
            <td style="text-align: left">{{ order.product.name }}</td>
            <td>{{ order.confirm_amount|default_if_none:0 }}</td><!-- æ‰£é™¤è´ˆé€é‡å¾Œè¨ˆåƒ¹æ•¸ -->
            <td>{{ order.product.price }}</td>
            <td>{{ order.orderTotalPrice }}</td>
            <td>{{ order.notes|default_if_none:"" }}</td>
        </tr>

        {% endfor %}
        <tr>
            <!-- <td>åœ˜è³¼æ‰¹è™Ÿ</td>
            <td>è¨‚å–®ç·¨è™Ÿ</td> -->
            <td colspan="3">å°è¨ˆ</td>
            <td colspan="4">{{ checkout.orderSum|default:0 }}</td>
            <!-- <td>é‡‘é¡é”æ¨™å…é‹å„ªæƒ </td>
            <td>ç“¶æ•¸é”æ¨™å…é‹å„ªæƒ </td>
            <td>å…¨åœ˜æŠ˜æ‰£</td> -->

        </tr>
        <tr>
            <!-- <td>{{ final.session }}</td>
            <td>{{ final.è¨‚å–®ç·¨è™Ÿ }}</td> -->
            <!-- <td>{{ final.é‡‘é¡é”æ¨™å…é‹å„ªæƒ  }}</td>
            <td>{{ final.ç“¶æ•¸é”æ¨™å…é‹å„ªæƒ  }}</td>
            <td>{{ final.å…¨åœ˜æŠ˜æ‰£å„ªæƒ  }}</td> -->
        </tr>
        <!-- <tr>
            <td colspan="5" style="text-align: left">æŠ˜æ‰£å‰åƒ¹æ ¼</td>
            <td colspan="3">{{ final.æŠ˜æ‰£å‰åƒ¹æ ¼ }}</td>
        </tr> -->
        <tr>
            <td colspan="3" style="text-align: left">è‡ªå–ä»˜æ¬¾é‡‘é¡</td>
            <td colspan="4">{{ checkout.price_after_disc|default:0 }}</td>
        </tr>
        <tr>
            <td colspan="3" style="text-align: left">é‹è²»</td>
            <td colspan="4">{{ checkout.ship_fee|default:0 }}</td>
        </tr>
        <tr>
            <td colspan="3" style="text-align: left">å®…é…ä»˜æ¬¾é‡‘é¡</td>
            <td colspan="4">{{ checkout.total_price|default:0 }}</td>
        </tr>

    </table>

    {% if checkout %}
    <br>
    <h4>ç”¨æˆ¶åŸºæœ¬è³‡æ–™</h4>
    <table id="member_info" class="text-left">

        <tr>
            <th colspan="2" style="text-align: center" class="user_info_title">åŒ¯æ¬¾èˆ‡å–è²¨è³‡è¨Šå¡«å¯«</th>
        </tr>
        <tr>
            <th class="user_info_title">è¨‚è³¼äºº</th>
            <td>
                {{ member.name }}
            </td>
        </tr>
        <tr>
            <th class="user_info_title">åŒ¯æ¬¾è³‡è¨Š</th>
            <td>
                åŒ¯æ¬¾éŠ€è¡Œï¼š{{ member.helper.bank_account_branch }} <br>
                å¸³è™Ÿï¼š{{ member.helper.bank_account_no }} <br>
                æˆ¶åï¼š {{ member.helper.bank_account_title }}
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text> åŒ¯æ¬¾é‡‘é¡</th>
            <td>
                <input id="input_transfer_amount" type="number"
                    value="{{ checkout.transfer_amount|default_if_none:'' }}">
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>åŒ¯æ¬¾å¸³æˆ¶æœ«äº”ç¢¼<br>
                (è«‹å¡«å¯«å­˜è¤¶æˆ–å¡ç‰‡èƒŒé¢å¾Œ5ç¢¼/ç„¡è¤¶å­˜å…¥å¡«å¯«åŒ¯æ¬¾äººå§“å)</th>
            <td>
                <input id="input_transfer_account" type="value"
                    value="{{ checkout.transfer_account|default_if_none:'' }}">
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>email(è«‹ç•™å¸¸ç”¨ä¿¡ç®±)</th>
            <td>
                <input id="input_email" type="email" size="30" value="{{ member.email|default_if_none:'' }}"></td>
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>æ‰‹æ©Ÿ</th>
            <td>
                <input id="input_phone" type="value" size="30" value="{{ member.phone|default_if_none:'' }}"></td>
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>å–è²¨æ–¹å¼</th>
            <td>
                <label for="self-take-tp"><input type="radio" name="deliver-way" id="self-take-tp"
                        {% if checkout.ship_method == "tp" %} checked {%endif%} value="tp">
                    å…§æ¹–è‡ªå–ï¼ˆå°åŒ—å¸‚å…§æ¹–å€ç‘å…‰è·¯413è™Ÿ9æ¨“ä¹‹ä¸€ï¼‰</label><br>
                <label for="self-take-tc"><input type="radio" name="deliver-way" id="self-take-tc"
                        {% if checkout.ship_method == "tc" %} checked {%endif%} value="tc">
                    å°ä¸­è‡ªå–ï¼ˆå°ä¸­å¸‚è¥¿å±¯å€å¸‚æ”¿è·¯668è™Ÿï¼ˆè¿‘é»æ˜è·¯èˆ‡å¸‚æ”¿è·¯å£ï¼‰ï¼‰</label><br>
                <label for="self-take-false"><input type="radio" name="deliver-way" id="self-take-false" value="ship"
                        {% if checkout.ship_method == "ship" %} checked {%endif%}>
                    å†·è—å®…é…(å–®è³¼ä¸€èˆ¬å“é …æ¡å¸¸æº«é…é€/æˆ–åˆä½µé‹é€è©³å…¬å‘Šæˆ–åƒè€ƒå†·è—å®…é…æ”¶è²»è¡¨)</label>
            </td>
        </tr>
        <tr>
            <th colspan="2" style="text-align: center" class="user_info_title"><text
                    class="red-text">*</text>å®…é…è³‡è¨Šå¡«å¯«(è‡ªå–è€…ä¹Ÿé ˆå¡«å®…é…åœ°å€)</th>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>ç¸£å¸‚</th>
            <td>
                <input id="input_city" type="value" size="30" value="{{ member.city|default_if_none:'' }}">
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>åœ°å€(å€é„‰é®å¸‚)</th>
            <td>
                <input id="input_county" type="value" size="30" value="{{ member.county|default_if_none:'' }}">
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>éƒµéå€è™Ÿ</th>
            <td>
                <input id="input_zipcode" type="value" size="30" value="{{ member.zipcode|default_if_none:'' }}">
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>åœ°å€</th>
            <td>
                <input id="input_address" type="text" size="50" value="{{ member.address|default_if_none:'' }}">
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>æ”¶ä»¶äºº(è«‹å¡«å¯«ä¸­æ–‡å…¨å)</th>
            <td>
                <input id="input_name" type="text" size="30" value="{{ member.shipname|default_if_none:'' }}"></td>
            </td>
        </tr>
        <tr>
            <th class="user_info_title"><text class="red-text">*</text>é…é€æ™‚æ®µ</th>
            <td>
                <label for="deliver-morning"><input type="radio" name="deliver-time" id="deliver-morning"
                        {% if checkout.ship_time == "morning" %} checked {%endif%}
                        value="morning">13æ™‚å‰</label><br>
                <label for="deliver-noon"><input type="radio" name="deliver-time" id="deliver-noon"
                        {% if checkout.ship_time == "noon" %} checked {%endif%} value="noon">
                    14æ™‚-18æ™‚</label><br>
                <label for="deliver-all"><input type="radio" name="deliver-time" id="deliver-all" value="all"
                        {% if checkout.ship_time == "all" %} checked {%endif%}>ä¸æŒ‡å®š</label>
            </td>
        </tr>
        <tr>
            <th class="user_info_title">æŒ‡å®šé…é€æ—¥: <br>
                (ç„¡æ³•æŒ‡å®šâ€œé€±æ—¥â€/ æŒ‡å®šæ—¥æœŸå¿…éœ€æ™šæ–¼å¡«å–®å¾Œ10å¤©)</th>
            <td>
                <input id="input_deliver_date" type="text" size="30"
                    value="{{ checkout.ship_date|default_if_none:'' }}"></td>
            </td>
        </tr>
        <tr>
            <th class="user_info_title">ç™¼ç¥¨æŠ¬é ­(éœ€é–‹ç«‹ä¸‰è¯å¼ç™¼ç¥¨è«‹å¡«å¯«æ­¤æ¬„/ä¸¦å‹™å¿…å¡«å¯«å®Œæ•´å…¬å¸æŠ¬é ­)</th>
            <td>
                <input id="input_invoice_title" type="text" size="30" required
                    value="{{ member.invoice_title|default_if_none:'' }}"></td>
            </td>
        </tr>
        <tr>
            <th class="user_info_title">çµ±ä¸€ç·¨è™Ÿ(éœ€é–‹ç«‹ä¸‰è¯å¼ç™¼ç¥¨è«‹å¡«å¯«æ­¤æ¬„/è«‹å‹™å¿…ç¢ºèªçµ±ç·¨æ˜¯å¦æ­£ç¢º)</th>
            <td>
                <input id="input_invoice_id" type="text" size="30" value="{{ member.invoice_id|default_if_none:'' }}">
            </td>
            </td>
        </tr>
        <tr>
            <th class="user_info_title">å‚™è¨»</th>
            <td>
                <input id="input_notes" type="text" value="{{ checkout.notes|default_if_none:'' }}">
            </td>
        </tr>

        <tr>
            <th class="user_info_title">å°å¹«æ‰‹</th>
            <td> æœ‰å•é¡Œè«‹è¯çµ¡ä½ çš„å°å¹«æ‰‹ï¼šğŸ‘‰ğŸ‘‰ğŸ‘‰ <a href="{{ member.helper.user_profile_url }}"
                    target="_blank">{{ member.helper }}</a>
            </td>
        </tr>
    </table>
    <br>
    è¨»ï¼šæ¨™è¨˜ <text class="red-text">*</text> ç‚ºå¿…å¡«æ¬„ä½ï¼Œè«‹åœ¨é€å‡ºå‰ç¢ºèªå¡«å¯« ğŸ™ğŸ™ğŸ™
    <br><br>
    <button id="submitChange" class="btn btn-primary" onclick="submitChange()">é€å‡ºåŒ¯æ¬¾è³‡è¨Š</button>
    <br><br>
    {% load static %}
    <h4>é‹è²»è¦å‰‡</h4>
    <img id="ship_rule" src="https://temporary0.s3-ap-southeast-1.amazonaws.com/INNOPRO/ship_rule.png" alt="">
    {% endif %}  <!-- if checkout -->
    {% endif %}
</div>

{% endblock content %}

{% block styles %}
<style>
    #ship_rule {
        width: 80vw;
        height: auto;
    }

    #fb-search>input,
    button {
        font-size: 20px;
    }

    .red-text {
        color: red
    }

    #table-items tr td {
        text-align: center;
    }

    .announcement {
        padding: 20px;
        background-color: antiquewhite;
    }

    table {
        width: 100%;
        /* border: solid black 1px; */
        border-collapse: collapse;
    }

    th,
    td,
    tr {
        border: solid black 1px;
        padding: 5px;
        /* font-size: 18px; */
    }

    td>input {
        font-size: 16px;
        width: 90%;
        height: 25px;
    }

    .user_info_title {
        text-align: left;
        width: 200px;
    }

    #submitChange {
        font-size: 20px;
        border-radius: 5px;
    }

    #warning,
    .warning {
        font-size: 12px;
        color: red;
    }

    .notes_fb_format {
        font-size: 16px;
    }

    .notes_fb_format>ul {
        list-style: none;
        padding-left: 0;
    }


    .notes_fb_format>ul>li {
        background-color: #F9F2F4;
        color: #008000;
        margin-top: 10px;
        width: fit-content;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let inputFBUrl = function () {
        let fb_url = document.querySelector('#input_fb_url').value
        let data = {
            'fb_url': fb_url
        }

        $.ajax({
            //æäº¤æ•¸æ“šçš„é¡å‹ POST GET
            type: "POST",
            //æäº¤çš„ç¶²å€
            url: "/fbUrlToId/",
            //æäº¤çš„æ•¸æ“š
            data: data,
            //è¿”å›æ•¸æ“šçš„æ ¼å¼
            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".
            //åœ¨è«‹æ±‚ä¹‹å‰èª¿ç”¨çš„å‡½æ•¸
            // beforeSend: function () { $("#msg").html("logining"); },
            //æˆåŠŸè¿”å›ä¹‹å¾Œèª¿ç”¨çš„å‡½æ•¸             
            success: function (data) {
                console.log(data)
                if (data.fbuid) {
                    console.log(data.fbuid)
                    $('#warning').text('')
                    window.location = data['fbuid']
                } else {
                    console.log('not an user')
                    $('#warning').text('æ­¤å¸³è™Ÿæ²’æœ‰è¿‘æœŸçš„è¨‚è³¼è¨˜éŒ„')
                }

            },
            //èª¿ç”¨åŸ·è¡Œå¾Œèª¿ç”¨çš„å‡½æ•¸
            // complete: function (XMLHttpRequest, textStatus) {
            //     alert(XMLHttpRequest.responseText);
            //     alert(textStatus);
            //HideLoading();
            // },
            //èª¿ç”¨å‡ºéŒ¯åŸ·è¡Œçš„å‡½æ•¸
            error: function (e) {
                console.log(e)
                //è«‹æ±‚å‡ºéŒ¯è™•ç†
            }
        });


    }

    let click = document.querySelector('#click')
    try {
        click.addEventListener('click', inputFBUrl)
    } catch (error) {
        console.log(error)
    }

    let submitChange = function () {
        let confirm = window.confirm("ç¢ºå®šå¿…å¡«æ¬„ä½éƒ½æœ‰å¡«å¯«æ­£ç¢ºè³‡è¨Šï¼Ÿ")
        if (confirm) {
            let email = $('#input_email').val() !== '' ? $('#input_email').val() : null
            let phone = $('#input_phone').val() !== '' ? $('#input_phone').val() : null
            let city = $('#input_city').val() !== '' ? $('#input_city').val() : null
            let county = $('#input_county').val() !== '' ? $('#input_county').val() : null
            let zipcode = $('#input_zipcode').val() !== '' ? $('#input_zipcode').val() : null
            let address = $('#input_address').val() !== '' ? $('#input_address').val() : null
            let name = $('#input_name').val() !== '' ? $('#input_name').val() : null
            let invoice_id = $('#input_invoice_id').val() !== '' ? $('#input_invoice_id').val() : null
            let invoice_title = $('#input_invoice_title').val() !== '' ? $('#input_invoice_title').val() : null
            let ship_method = $("input[type='radio'][name='deliver-way']:checked").val();
            let deliver_time = $("input[type='radio'][name='deliver-time']:checked").val() === undefined ? 'all' : $("input[type='radio'][name='deliver-time']:checked").val();
            let deliver_date = $('#input_deliver_date').val() !== '' ? $('#input_deliver_date').val() : null
            let transfer_amount = $('#input_transfer_amount').val() !== '' ? $('#input_transfer_amount').val() : null
            let transfer_account = $('#input_transfer_account').val() !== '' ? $('#input_transfer_account').val() : null
            let notes = $('#input_notes').val() !== '' ? $('#input_notes').val() : null
            let data = {
                'user_fb_id': $('#userName')[0].getAttribute('fbuid'),

                'email': email,
                'phone': phone,
                'city': city,
                'county': county,
                'address': address,
                'zipcode': zipcode,
                'name': name,
                'invoice_id': invoice_id,
                'invoice_title': invoice_title,
                'ship_method': ship_method,
                'ship_time': deliver_time,
                'ship_date': deliver_date,
                'transfer_amount': transfer_amount,
                'transfer_account': transfer_account,
                'notes': notes
            }
            console.log(data)

            $.ajax(
                {
                    //æäº¤æ•¸æ“šçš„é¡å‹ POST GET
                    type: "POST",
                    //æäº¤çš„ç¶²å€
                    url: "",
                    //æäº¤çš„æ•¸æ“š
                    data: data,
                    //è¿”å›æ•¸æ“šçš„æ ¼å¼
                    datatype: "json",
                    //æˆåŠŸè¿”å›ä¹‹å¾Œèª¿ç”¨çš„å‡½æ•¸             
                    success: function (data) {
                        
                        if (data.status === 'success') {
                            console.log(data)
                            window.alert('è³‡æ–™ä¸Šå‚³æˆåŠŸ')
                            location.reload()
                        } else {
                            window.alert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦')
                        }
                    },
                    //èª¿ç”¨åŸ·è¡Œå¾Œèª¿ç”¨çš„å‡½æ•¸
                    // complete: function (XMLHttpRequest, textStatus) {
                    //     alert(XMLHttpRequest.responseText);
                    //     alert(textStatus);
                    //HideLoading();
                    // },
                    //èª¿ç”¨å‡ºéŒ¯åŸ·è¡Œçš„å‡½æ•¸
                    error: function (e) {
                        console.log(e)
                        //è«‹æ±‚å‡ºéŒ¯è™•ç†
                    }
                }
            );

        } else {
        }
    }



</script>
{% endblock %}